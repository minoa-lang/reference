# Attributes
```
<attribute> := '@' [ '!' ] <simple-path> [ '(' <attrib-meta> { ',' <attrib-meta> } [ ',' ] ')' ]
<attrib-meta> := <name>
               | <name> '=' <expr>
               | <name> '(' <attrib-meta> { ',' <attrib-meta> } [ ',' ] ')'
```

An attribute is general metadata that is given to the compiler, the resulting action depends on the attribute itself.
There are 2 types of attributes:
- module attributes starting with `@!`
- normal attributes starting with `@`

The difference between these attributes, is that the first one defined an attribute that is applied to the module it is in (or on the library if the file is a root module),
while the second applies to the item following it.

Expression may be used inside of attributes, but they cannot start using a name.

The following elements can have a attribute applied to them:
- All items
- Most statements
- Block expressions
- Enum variants
- Struct fields
- Match arms
- Function, function pointer, and closure paramters

> _TODO_: Explain how @attr(sub = "") and @attr(sub("")) are interchangable

## Built-in attributes [↵](#attributes)

Built-in attributes are attributes that the compiler can use to change its behavior.

### Conditional compilation attributes [↵](#built-in-attributes-)

#### `cfg` [↵](#conditional-compilation-attributes-)

The `cfg` attribute can be used to change the what code is compiled when certain configuration condtions are matched.
The `cfg` attribute is similar to the [`when` expression](./expressions/when-expressions.md), but is only allowed to access configuration values, these can be combined with lazy boolean operators and the not operator to define the condition for when the code should be compiled in.

#### `cfg_attr` [↵](#conditional-compilation-attributes-)

The `cfg_attr` attribute can be used to change whether an attribute is applied when certain configurations are matched.
The `cfg_attr` is similar to the `cfg` attribute, but instead of being applied to the element below it, it has a second paramter containing the actual attribute that it represents

### Derive attributes [↵](#built-in-attributes-)

#### `derive` [↵](#derive-attributes-)

The `derive` attribute allows new items to automatically implement code for a given type, and is mainly used to implement attributes.
The derive contains a list of derive meta-attributes to derive.
Each derive meta-attribute may be supplied additional data that is attached to the meta-attribute.
For example `@derive(foo(bar = 1))`, passes the inner `bar = 1` to the derive attribute.


It contains a list of meta data with paths to builtin traits to implement or derive macros to process.

#### `auto_derive` [↵](#derive-attributes-)

The `auto_derive` attribute is automatically added to any implementations generated by the `derive` attribute.
This attribute has no effect, but allows for tools and lints to detct that these have been automatically generated

### 17.1.3. Macro attributes [↵](#built-in-attributes-)

#### `meta_order` [↵](#derive-attributes-)

The `meta_order` attribute is used to wrap [meta-attributes](./metaprogramming.md#meta-attributes-) and control their order of execution.

The attribute contain the attribute to wrap, followed by a `before` and/or `after` argument with the names of the attribute that it should run before or after.

For example, `@meta_order(foo, before(bar), after(baz, quux))`, means that the `foo` attribute should run before `bar` is run, but after both `baz` and `quux`.

### Diagnostic attributes [↵](#built-in-attributes-)

These attributes are used for controlling or generating diagnostic messages during compilation

#### `lint` attributes [↵](#diagnostic-attributes-)

Linting attributes allows linters to check for potentially undesirable code patterns, such as unreachable code or omitted documentation.

The following lints attributes are supported:
- `allow(rule)`: overrides checks for `rule` and allows them to be treated as valid, so they are ignored.
- `warn(rule)`: Generates a warning whenever an occurance of `rule` is found, but continues compilation
- `deny(rule)`: Generates an error whenever an occurance of `rule` is found, and terminates compilation
- `forbid(rule)`: Similar to `deny`, but must be at a library level and forbids changing the lint level afterwards

The `rule`s used for these lint checks can be one of the standard compiler lints, or additional linter-specific rules.

Lint attributes are allowed to override the level specified by a previously define lint attribute, as lolng as the level does not try to change a forbidden lint.
Previous attributes are attributes defined in a higher level in the module hierarchy, or those passed directly to the compiler

##### Lint groups [↵](#lint-attributes-)

Lint attributes may be combined within lint groups, these have distint names and simultaniously set the lint level for all underlying attributes.
Lint groups can have their individual lint rules overriden by subsequent lint groups.

##### Tool lints [↵](#lint-attributes-)

A tool lints are scopes lint rules for certain tools.

Tool lints only get checked when their associated tools are active.
If a tool lint is encountered, but its tools is not active, they will be ignored

#### `available` & `unavailable` [↵](#diagnostic-attributes-)

The `available` attribute defines since what minimum version of the library an item is available.
The `unavailable` attribute is the oposite of `available` and specifiers for which systems the feature is not available.

In addition, it may also define on which systems it is available and which system flags needs to be supported.

The attribute contains a version number, in addition to zero or more of the following sub-attributes and their respective configuration options:
sub-attribute | configuration option
--------------|----------------------
`arch`        | [`target_arch`](./configuration-options.md#target_arch-)
`arch_feats`  | [`target_features`](./configuration-options.md#target_feature-)
`os`          | [`target_os`](./configuration-options.md#target_os-)

#### `deprecated` [↵](#diagnostic-attributes-)

The `deprecated` attributes allows items to marked as deprecated and will generate a warning on any use of it.

The `deprecated` attribute can be defined in multiple ways:
- `deprecated`: issues a generic message
- `deprecated("message")`: includes the given string in the deprecation message
- `deprecated(...)`: includes the given attributes in the deprecation message
    - `msg`: The main message
    - `note`: Additional notes for the deprecated item, can be used for to specify alternatives, or additional info why it was deprecated
    - `since`: Defines the semantic version of the library in which this item was deprecated.
    - `renamed`: Used to indicate which function should now be used, if it takes the same arguments. Tooling can use this to automatically fix any occurances of the function.

#### `obsolete` [↵](#diagnostic-attributes-)

The `obsolete` attribute is similar to `deprecated`, but will instead of resulting in a warning, an error will be generated.

Likd `deprecated`, the `obsolete` attribute can be defined in the following ways:
- `obsolete`: issues a generic message
- `obsolete("message")`: includes the given string in the deprecation message
- `obsolete(...)`: includes the given attributes in the deprecation message
    - `msg`: The main message
    - `note`: Additional notes for the obsolete item, can be used for to specify alternatives, or additional info why it was obsolete
    - `since`: Defines the semantic version of the library in which this item was obsolete.
    - `renamed`: Used to indicate which function should now be used, if it takes the same arguments. Tooling can use this to automatically fix any occurances of the function.

#### `noasync` [↵](#diagnostic-attributes-)

The `noasync` attribute notifies that a given function cannot be used inside of an async function.
The attribute can provide a message that explains why it cannot be used.

`async` function have no guarantee on which thread they will run, or that they will even complete on a single thread.
Therefore things like thread-local storage and locks can cause issues when transfered to a different thread.

#### `must_use` [↵](#diagnostic-attributes-)

The `must_use` attribute will issue an warning or error (depending on the current lint level) when the resulting item is not used.
They can be defined on user-defined types and any kind of funtion.

When applied to a user-defined type, any return of a value of this type will result a message.
When applied to a function, if the return value of that function is not used, it will result in a message.

The `must_use` can return a generic message, or can be supplied with a message (`must_use("reason")`), which will print out the reason why the value must be used.

#### `diagnostics` [↵](#diagnostic-attributes-)

The `diagnostics` attribute is a namespace of attributes that can affect compile time error reporting.
The hints provided by these attributes are not guaranteed to be used.
Unknown attributes in this namespace are accepted, though they may emit warnings for unsused attributes.

_TODO: Add diagnostics sub-attribs_

### ABI, link, symbol, and FFI attributes [↵](#built-in-attributes-)

These attribute control how `extern` and `export` items will be managed

> _Note_: To control how a specific library is linked, use either command line options or a `build.mn` script

#### `link_prefix` [↵](#abi-link-symbol-and-ffi-attributes-)

The `link_prefix` attribute set a common prefix for all link names whithin a block

#### `link_suffix` [↵](#abi-link-symbol-and-ffi-attributes-)

The `link_suffix` attribute set a common suffix for all link names whithin a block

#### `link_name` [↵](#abi-link-symbol-and-ffi-attributes-)

The `link_name` attribute is used to specify the link name of an external function or static.

#### `link_ordinal` [↵](#abi-link-symbol-and-ffi-attributes-)

The `link_ordinal` can be used to specify the numeric ordinal of an external function or static.
The ordinal is a unique number identifying a symbol exported by a dynamic library on windows and can be used when the library is being loaded to find that symbol rather than having to look it up by name.

> _Warning_: The `link_ordinal` should only be used in cases where the ordinal of the symbol is stable: if the ordinal of a symbol is not explicitly set when its containing binary is built, then one will automitically be assigned to it, and that assigned oridinal may change between builds of the binary.

> _Note_: Not all libraries support ordinals

#### `repr` [↵](#abi-link-symbol-and-ffi-attributes-)

The `repr` trait controls the type layout as defined in the [Layout representation section](./type-system/type-layout/layout-representation.md)

#### `export_name` [↵](#abi-link-symbol-and-ffi-attributes-)

The `export_name` attribute specifies the name of the symbol that will be exported on a function or static.

#### `link_section` [↵](#abi-link-symbol-and-ffi-attributes-)

The `link_section` attribute specifies the section of the object file that a function of static's content will be placed into.

#### `no_mangle` [↵](#abi-link-symbol-and-ffi-attributes-)

The `no_mangle` attribute disables name mangling and will output a symbol with the same name as  the function or static.

#### `used` [↵](#abi-link-symbol-and-ffi-attributes-)

The `used` attribute can only be applied to static items.
This attribute is used to keep the variable in the output object file, even if the variable is not used or referenced by any other item inside the library.
However, the linker is still free to remove such an item.

#### `callconv` [↵](#abi-link-symbol-and-ffi-attributes-)

The `callconv` attribute defined which calling convention a function will use when called.

#### `contextless` [↵](#abi-link-symbol-and-ffi-attributes-)

The `contextless` attribute defines a function as running without access to the implicit context, maning that it will use the `contextless` ABI without having to be declared as [`extern` or `export`](./items/functions.md#external--exported-functions- ).
This means that this also can be applied on [methods](./items/functions.md#methods-).

### Code generation attributes [↵](#built-in-attributes-)

Code generation attributes affect the resulting code generated by the compiler.
They give hints to the compiler to allow it to generate code that might be faster without these hints.
The compiler is free to ignore these hints

#### `builtin` [↵](#code-generation-attributes-)

The `builtin` attributes attribute tells the compiler that the following element needs to be handled by the compiler, as it represents something which cannot be declared exclusivly within code.

#### `inline` [↵](#code-generation-attributes-)

The `inline` attributes suggests taht the function should be placed inline in the caller, rather than generating a function call.
The following variations of the attribute are allowed:
- `inline`: suggest performing an inline expansion, i.e. strongly hints at it
- `inline(force)`: forces the compiler to always performing an inline expensions
- `inline(never)`: forces the compiler to never inline expansions

> _Note_: The compiler automatically inlines code based on a set of heuristics, these attributes apply modifiers to the heuristics on when to inline.
> Incorrect usage of this attribute may result in slower code, so should be used with care.

#### `cold` [↵](#code-generation-attributes-)

The `cold` attribute suggest that the function is unlikely to be called.

#### `track_caller` [↵](#code-generation-attributes-)

The `track_caller` attribute allows code within the function to get a hint of the `Location` of the top-most tracked call that leads to the function's invocation.
At the point of observation, an implementation behaves as if it walks up the stack from the function's frae to find the nearest frame of an unattributed function, and return the location of the tracked caller.

It can be applied to all `Minoa` ABI functions with the exception of the main function.
When applied to a function declaration inside of a trait, it will be applied to all implementations, if it is applied to a default implementation, it will also be applied to all overriding implementations.

#### `instruction_set` [↵](#code-generation-attributes-)

The `instruction_set` attribute allows multiple identical function to be generated based on the instruction set being used in a program that can run multiple instructions sets on CPU architectures that support it.
An example of this is normal and thumb arm code.

#### `opt_level` [↵](#code-generation-attributes-)

The `opt_level` attribute can be used to override the optimization level for a given functions.
This has the same possible values as the `opt_level` compiler setting.

#### `no_alias` [↵](#code-generation-attributes-)

The `no_alias` attribute is applied to function parameters with a pointer or pointer-like types, guaranteeing that these do not alias and may therefore apply optimizations based on this fact.

#### `bit_size` [↵](#code-generation-attributes-)

The `bit_size` attribute is used to explicitly define the bitsize of a type when used in a [bitfield](./type-system/types/bitfield-types.md).
The attribute takes an integer literal value defining the bitwidth of a type in bits.

#### `field_prioity` [↵](#code-generation-attributes-)

The `field_priority` attribute is used to define the priority of field within a `struct` with a Minoa representation, see [field priority](./type-system/type-layout/layout-representation.md#field-priority-).

#### `val_range` [↵](#code-generation-attributes-)

The `val_range` attribute is used to define a range of valid value for any type that contains a single integer element.
This information can then be used for optimization by the compiler.

#### `autoclosure` [↵](#code-generation-attributes-)

This marks an argument that receives a closure as being allowed to implicitly convert the value into closure.

#### `spec_priority` [↵](#code-generation-attributes-)

The `spec_priority` attribute is uses in case there is a possible collision between specialization, see [resolving collisions](./generics.md#resolving-collisions-)

#### `panic_handler` [↵](#code-generation-attributes-)

The `panic_handler` attribute is used to specify a user provided panic handler.

#### `safety_check` [↵](#code-generation-attributes-)

The `safety_check` attribute allows the control on whether safety check check should be generated for checkable illegal behaviors.
Safety check can can be either be set on at the top level, or on a category or sub-category level.

The following modes are supported:
- `on`: Safety checks will always generated
- `debug`: Safety checks will only generated in debug builds
- `off`: Safety checks are not generated

The default is `debug`.

Below is a table with mappings between `safety_check` attribute categories and their associated illegal behaviors

category  | sub-category    | illegal behavior
----------|-----------------|--------------------
`integer` |                 | [all integer IB](./illegal-behavior.md#integer-)
`integer` | `truncation`    | [integer truncation](./illegal-behavior.md#trunctation-)
`integer` | `overflow`      | [integer overflow/underflow](./illegal-behavior.md#overflowunderflow--)
`integer` | `div_by_0`      | [division by 0](./illegal-behavior.md#division-by-0--)
`fp`      |                 | [all floating point IB](./illegal-behavior.md#floating-point-)
`fp`      | `illegal_fp`    | [illegal operations](./illegal-behavior.md#illegal-operations-)
`fp`      | `fptoi_oob`     | [Floating-point to integer out-of-bounds](./illegal-behavior.md#floating-point-to-integer-out-of-bounds-)
`memory`  |                 | [all memory IB](./illegal-behavior.md#memory-)
`memory`  | `out_of_bounds` | [Out-of-bounds](./illegal-behavior.md#out-of-bounds-)
`memory`  | `ptr_align`     | [Incorrect memory alignment](./illegal-behavior.md#incorrect-pointer-alignment-)
`memory`  | `sentinel`      | [Sentinel access](./illegal-behavior.md#sen)

Categories and sub-categories may be set in addition to a more general value.

#### Examples [↵](#safety_check-)
```
@safety_check(.on) // Turn all check on
@safety_check(integer(div_by_0 = .on)) // Only turn integer division by 0 on

// Set the following
// - `.debug` for all safety checks, but
// - turn integer safety check to `.on`, but
// - turn integer overflow safety checks to `.off`
@safety_check(.debug, integer(.off, overflow = .on))
```

#### `fp_control` [↵](#code-generation-attributes-)

The `fp_control` attribute allows control of how floating point operations are handled to set for a specific item, overwriting the default value for the program.

The possible controls are defined below.

> _Note_: Check the relavent section to see the supported architectures for each settings, if none are explicitly mentioned, the setting is available on all platforms

> _Note_: floating point controls can also be set at runtime

> _Note_: Setting floating point controls may prevent the compiler from fully inlining other function, or being inlined witin functions which have different `fp_control`s set

> _Todo_: If Bfloat16 is supported, at controls for ARM's EBF (extended brain float behaviors), and NEP (lowest element determination for SIMD) control bit

##### `exceptions` [↵](#fp_control-)

The `exceptions` control is a mask of flags that decide what floating point exceptions (and therefore IB) can be trigered.
If the exception can't be triggered, the instructions will return a value.

Below are the possible `exceptions` that can be set, and the default value that is returned when not.

`exceptions`  | value when off                             | meaning
--------------|--------------------------------------------|----------------
`.none`       | n/a                                        | Disable all flags
`.all`        | n/a                                        | Enables all flags
`.invalid_op` | `NaN`, depends on `nan_mode`               | a mathematically undefined operation, e.g. `sqrt(-1)`.
`.div_by_0`   | `+inf` or `-inf`, based on sign of operand | an operation on a finite operand that results in an exact infinite result, e.g. `1.0/0.0` or `log(0.0)`.
`.overflow`   | `+inf`                                     | a finite result is too large to be represented accurately (i.e. its exponent with an unbounded exponenet range would be larger that the maximum exponent).
`.underflow`  | subnormal, depends on `denormal`           | a result is very small (outsize of normal range).
`.inextact`   | Rounded value according to rounding mode   | the exact (i.e. unrounded) result is not represetable exactly.
`.denorm_in`  | n/a                                        | one of the operands passed to the instruction is a denormal value.

`exceptions` can be set to a combinations of flags, e.g. `.invalid_op | .div_by_0`

The default value of `exceptions` is `.all`

> _Note_: the `denormal_in` exception is only support on x86/64 processors

##### `rounding` [↵](#fp_control-)

The `rounding` control controls how values are rounded when there is not enough precision to store the full result, and can be set to the following:
- `.nearest`: Round towards nearest even value
- `.neg_inf`: Round towards -infinity
- `.pos_inf`: Round towards infinity
- `.zero`: Round towards zero

The default value of `rounding` is `.even`

##### `flush_to_zero` [↵](#fp_control-)

The `flush_to_zero` control decides what should happen when a denormal value is generated by an instructions, and can be set to the following values:
- `.save`: Keeps the denormal value
- `.flush`: Flushed any denormal value, i.e. set value to 0 when a denormal is generated. This mode is not IEEE compliant, but can provide performance improvements.

> _Note_: `flush_to_zero_half` is only supported on x86/64 and ARM

##### `flush_to_zero_half` [↵](#fp_control-)

The `flush_to_zero_half` control similar to `flush_to_zero`, expect that it defines this mode for half precision floatin points, and can be set to the following values:
- `.save`: Keeps the denormal value
- `.flush`: Flushed any denormal value, i.e. set value to 0 when a denormal is generated. This mode is not IEEE compliant, but can provide performance improvements.

> _Note_: `flush_to_zero_half` is only supported on ARM

##### `denormal_zero` [↵](#fp_control-)

The `denormal_zero` control controls how denormal operand to instructions should be interpreted, and can be set to the following values:
- `.denormal`: Passes the denormal to the operation as it is
- `.zero`: Inteprets any denormal input as 0. This mode is not IEEE compliant, but can provide performance improvements.

> _Note_: `flush_to_zero_half` is only supported on x86/64 and ARM

##### `precision` [↵](#fp_control-)

The `precision` control defines what precision x87 floating points do there calculations at, and can be set to the following:
- `.single`: Reduces x87 instruction to to 24-bit mantissa precision (f32 precision)
- `.double`: Reduces x87 instruction to to 53-bit mantissa precision (f64 precision)
- `.extended`: x87 instructions utilize the full 64-bit mantissa available (f80 precision)

The default value of `precision` is `.extended`

> _Note_: `precision` is only supported on x86/64, when x87 FPU instructions are used

##### `alt_half` [↵](#fp_control-)

The `alt_half` control defines whether an alternate version of half precision floating points is used, and can be set to the following:
- `.off`: Use the IEEE-754 rounding mode
- `.on`: Use ARM's alternate half fp format. This mode is not IEEE compliant.

The default value of `alt_half` is `.off`

On ARM, an alternate half is similar to a IEEE 754 half, but it does not support special values, instead uses those possible bitpatterns as valid values.

> _Note_: `alt_half` is only supported on ARM

##### `nan_mode` [↵](#fp_control-)

The `nan_mode` control defines how the input NaN value is passed through the operation, and can be set to the following:
- `.propagate`: Propagates/return the input NaN if provided, otherwise return the generated NaN.
- `.generate`: Return a default generated NaN. This mode is not IEEE compliant.

The default value of `nan_mode` is `.propagate`.

> _Note_: `alt_half` is only supported on ARM

##### `alt_handling` [↵](#fp_control-)

The `alt_handling` control defines wether the processor should use alternative handling for floating point numbers, and can be set to the following
- `.off`: Use standard handling
- `.on`: Use alternative handling. This mode is not IEEE compliant.

> _Note_: `alt_handling` is only supported on ARM, for more info, see the ARM architectural reference C5.2.8

### 17.1.7. Module attributes [↵](#built-in-attributes-)

These are module specific attributes

#### `path` [↵](#1717-module-attributes-)

The `path` attribute defines a path a module uses, as defined in [module path attribute section](./items/modules.md#path-attribute-)

### 17.1.8. Debug attributes [↵](#built-in-attributes-)

Debug attributes allow for additional debug information to be specified for a given item.

#### `debugger_visualizer` [↵](#debug-attributes-)

The `debugger_visualizer` attribute can be used to embed debugger visualizer info into the debugging information.
This enables an improved debugger experience for displaying values in the debugger.

The attribute exists out of a `kind` and either a `file` or `inline` specifier.

The `kind` specifier can be one of the following
- `natvis`: XML-based natvis for microsoft debuggers. More detail on the format can be found in Microsoft's [natvis documentation](https://learn.microsoft.com/en-us/visualstudio/debugger/create-custom-views-of-native-objects?view=vs-2022).
- `gdb`: GDB uses a python script based visualizer. More details on the format can be found in GDB's [pretty printing documentation](https://sourceware.org/gdb/current/onlinedocs/gdb.html/Pretty-Printing.html).
- `minoa`: Minoa specific debug visualization (not supported yet)

The actual visualization can be specified in 2 ways:
- `file`: the visualization is specified in an internal file, this contains a path to it.
- `inline`: the visualization is specified inline inside of the code file

### Documentation comments

#### `doc` [↵](#documentation-comments)

The `doc` comment specifies a pseudo-attribute that represent [doc comments](./lexical-structure/comments.md#doc-attribute-).

## Tool attributes [↵](#attributes)

Tool attributes allow for external tools to supply its own attributes, with their own namespace

## User-defined attributes [↵](#attributes)

User-defined attributes are done using [meta attributes](./metaprogramming.md#meta-attributes-).

In addition, result builders can also be used as the name in these attributes.
